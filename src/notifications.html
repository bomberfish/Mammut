<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="theme-color" content="#ffffff" />
    <meta
      name="theme-color"
      media="(prefers-color-scheme: dark)"
      content="#121212"
    />
    <meta name="darkreader-lock" />
    <title>Mammut - Notifications</title>
    <link rel="stylesheet" href="/styles/base.css" />
    <link rel="stylesheet" href="/styles/default.css" />
    <script>
      (function () {
        if (typeof window.JSON !== "object") {
          document.write('<script src="/lib/json2.js"><\/script>');
        }
      })();
    </script>
    <script type="text/javascript" src="/util.js"></script>
    <style>
      button,
      h3 {
        display: inline;
      }
    </style>
    <script>
      var token = localStorage.getItem("access_token");
      var domain = localStorage.getItem("instanceDomain");

      function getNotifications() {
        grab("/api/v1/notifications", "GET", true, function (xhr) {
          var response = JSON.parse(xhr.responseText);
          console.log(response);
          var notifications = response;
          if (notifications.length === 0) {
            document.body.innerHTML += "<p>You're all caught up!</p>";
            return;
          }
          document.querySelector("h3").innerHTML +=
            " (" + notifications.length + ")";
          var notificationList = document.createElement("ul");
          notificationList.id = "notificationList";
          document.body.appendChild(notificationList);

          for (var i = 0; i < notifications.length; i++) {
            var notification = notifications[i];
            var notificationItem = document.createElement("li");
            notificationItem.classList = "notificationItem";
            notificationList.appendChild(notificationItem);
            var notificationTitle = document.createElement("h4");
            notificationTitle.classList = "notificationTitle";
            var notificationText = document.createElement("p");
            notificationText.classList = "notificationText";

            if (notification.type === "moderation_warning" && notification.moderation_warning) {
                if (notification.moderation_warning.action === "delete_statuses") {
                  notificationTitle.textContent = "One or more of your posts have been deleted";
                } else {
                  notificationTitle.textContent = "Moderation warning";
                }
                var info = document.createElement("a");
                info.href = domain + "/disputes/strikes/" + notification.moderation_warning.id;
                info.innerHTML = "View details";
                info.setAttribute("target", "_blank");
                notificationTitle.appendChild(document.createTextNode(" "));
                notificationTitle.appendChild(info);
            } else {
              var acct = document.createElement("a");
              acct.href = "/user.html?id=" + notification.account.id;
              acct.innerHTML = "@" + notification.account.acct;
              acct.setAttribute("target", "content");
              if (notification.type === "favourite" || 
                  notification.type === "reblog" ||
                  notification.type === "mention") {
                    notificationTitle.appendChild(acct);

                    if (notification.type === "favourite") {
                      notificationTitle.appendChild(document.createTextNode(" favourited your post"));
                    } else if (notification.type === "reblog") {
                      notificationTitle.appendChild(document.createTextNode(" reblogged your post"));
                    } else if (notification.type === "mention") {
                      notificationTitle.appendChild(document.createTextNode(" mentioned you in a post"));
                    }

                  } else {
                notificationTitle.appendChild(document.createTextNode(
                  notification.type.charAt(0).toUpperCase() +
                  notification.type.substr(1) +
                  " from "
                ));
                notificationTitle.appendChild(acct);
                  }
            }

            if (notification.status) {
              notificationTitle.innerHTML+= ":"
            }

            notificationItem.appendChild(notificationTitle);

            if (notification.moderation_warning && notification.moderation_warning.text) {
              notificationText.innerHTML +=
                "<div class='notification-content'>Reason: " +
                notification.moderation_warning.text +
                "</div>";
            }

            if (notification.status) {
              if (notification.status.content) {
                notificationText.innerHTML +=
                  "<div class='notification-content'>" +
                  notification.status.content +
                  "</div>";

                const links = notificationText
                  .querySelector(".notification-content")
                  .querySelectorAll("a");
                for (var j = 0; j < links.length; j++) {
                  links[j].setAttribute("target", "content");
                  for (
                    var k = 0;
                    k < notification.status.mentions.length;
                    k++
                  ) {
                    if (
                      notification.status.mentions[k].url ===
                      links[j].getAttribute("href")
                    ) {
                      links[j].href =
                        "/user.html?id=" + notification.status.mentions[k].id;
                    }
                  }
                }
              }
              notificationItem.appendChild(notificationText);
              interpolateEmoji(notificationText, notification.status.emojis);
              var notificationButton = document.createElement("button");
              notificationButton.classList = "notificationButton";
              notificationButton.innerHTML = "View Post";
              const url = "/status.html?id=" + notification.status.id;
              console.log(url);
              notificationButton.onclick = function () {
                window.open(url, "content");
              };
              notificationItem.appendChild(notificationButton);
            } else {
              notificationItem.appendChild(notificationText);
            }

            notificationItem.innerHTML +=
              "<div class='notificationTime subdued' style='margin-top: 10px;'> at " +
              new Date(notification.created_at).toLocaleString() +
              "</div>";
          }
        });
      }

      function readAll() {
        grab("/api/v1/notifications/clear", "POST", true, function (xhr) {
          if (xhr.status === 200) {
            document.querySelector("h3").innerHTML = "Notifications";
            document.querySelector("#notificationList").remove();
            getNotifications();
          } else {
            alert("Failed to clear notifications: " + xhr.responseText);
          }
        });
      }

      getNotifications();
    </script>
  </head>

  <body>
    <div id="header">
      <h3>Notifications</h3>
      &nbsp;
      <button onclick="readAll()">Read</button>
      <button onclick="window.location.href = '/notifications.html'">
        Refresh
      </button>
    </div>
  </body>
  <!-- 100% privacy friendly analytics -->
<script data-collect-dnt="true" async defer src="https://site-stats.bomberfish.ca/latest.js"></script>
<noscript><img src="https://site-stats.bomberfish.ca/noscript.gif?collect-dnt=true" alt="" referrerpolicy="no-referrer-when-downgrade" /></noscript>
</html>
